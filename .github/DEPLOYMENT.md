# Настройка GitHub Actions для деплоя

## Необходимые секреты в GitHub

Добавьте следующие секреты в настройках репозитория:
**Settings → Secrets and variables → Actions → New repository secret**

### Обязательные секреты для SSH деплоя:

| Имя секрета | Значение | Пример |
|------------|----------|--------|
| `SERVER_HOST` | IP адрес вашего сервера | `192.168.1.100` или `example.com` |
| `SERVER_USER` | Имя пользователя для SSH | `root` или `ubuntu` |
| `SERVER_PATH` | Путь к проекту на сервере | `/root/receipty-bot` или `/home/ubuntu/receipty-bot` |
| `SSH_PRIVATE_KEY` | Приватный SSH ключ | Содержимое файла `~/.ssh/id_ed25519` |

### Секреты для переменных окружения бота:

| Имя секрета | Значение | Пример |
|------------|----------|--------|
| `TELEGRAM_BOT_TOKEN` | Токен Telegram бота | `123456789:ABCdefGHIjklMNOpqrsTUVwxyz` |
| `OPENAI_API_KEY` | API ключ OpenAI | `sk-...` |
| `GOOGLE_SHEETS_SPREADSHEET_ID` | ID Google таблицы (опционально) | `1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms` |
| `GOOGLE_SHEETS_TAB_NAME` | Название листа (опционально) | `november_2025` |

## Как получить SSH_PRIVATE_KEY:

1. На вашем локальном компьютере выполните:
   ```bash
   cat ~/.ssh/id_ed25519
   ```
   
2. Скопируйте весь вывод (включая строки `-----BEGIN OPENSSH PRIVATE KEY-----` и `-----END OPENSSH PRIVATE KEY-----`)

3. **ВАЖНО при добавлении в GitHub Secrets:**
   - Убедитесь, что ключ скопирован полностью, включая первую и последнюю строки
   - Не добавляйте лишних пробелов в начале или конце
   - Каждая строка должна заканчиваться символом новой строки (не CRLF, а LF)
   - Если возникают ошибки "error in libcrypto", попробуйте:
     - Удалить секрет и добавить его заново
     - Убедиться, что ключ начинается с `-----BEGIN` и заканчивается `-----END`
     - Проверить, что нет лишних пробелов или символов

4. Если у вас нет SSH ключа, создайте его:
   ```bash
   ssh-keygen -t ed25519 -C "github-actions"
   ```
   - При запросе пароля можно оставить пустым (нажмите Enter)
   - Запомните путь к ключу (обычно `~/.ssh/id_ed25519`)

5. **КРИТИЧЕСКИ ВАЖНО: Добавьте публичный ключ на сервер**
   
   **Вариант A: Если у вас есть доступ к серверу по паролю:**
   ```bash
   # Автоматически скопирует публичный ключ
   ssh-copy-id SERVER_USER@SERVER_HOST
   ```
   Вам будет предложено ввести пароль пользователя на сервере.
   
   **Вариант B: Если ssh-copy-id не работает, добавьте вручную:**
   ```bash
   # На локальном компьютере - скопируйте публичный ключ
   cat ~/.ssh/id_ed25519.pub
   ```
   
   Затем на сервере выполните:
   ```bash
   # Подключитесь к серверу (по паролю или другим способом)
   ssh SERVER_USER@SERVER_HOST
   
   # Создайте директорию .ssh если её нет
   mkdir -p ~/.ssh
   chmod 700 ~/.ssh
   
   # Добавьте публичный ключ в authorized_keys
   echo "ВАШ_ПУБЛИЧНЫЙ_КЛЮЧ_ИЗ_ВЫВОДА_CAT" >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   ```
   
   **Важно:** Замените `ВАШ_ПУБЛИЧНЫЙ_КЛЮЧ_ИЗ_ВЫВОДА_CAT` на реальный публичный ключ из вывода команды `cat ~/.ssh/id_ed25519.pub`

## Проверка подключения:

После настройки секретов проверьте подключение **БЕЗ ПАРОЛЯ**:
```bash
ssh SERVER_USER@SERVER_HOST
```

Если подключение требует пароль, значит публичный ключ не добавлен правильно на сервер. Проверьте:
- Файл `~/.ssh/authorized_keys` на сервере содержит ваш публичный ключ
- Права доступа: `~/.ssh` должен быть `700`, `authorized_keys` должен быть `600`
- Пользователь на сервере совпадает с `SERVER_USER` в секретах

## Что делает workflow:

1. При пуше в ветку `main` или `master`:
   - Собирает Docker образ
   - Копирует файлы на сервер через SSH
   - Останавливает старый контейнер
   - Собирает новый образ на сервере
   - Запускает новый контейнер с переменными окружения

## Устранение неполадок:

### Ошибка "Permission denied (publickey,password)"

Эта ошибка означает, что SSH не может аутентифицироваться. Возможные причины:

1. **Публичный ключ не добавлен на сервер** (самая частая причина)
   - Убедитесь, что вы выполнили шаг 5 выше
   - Проверьте, что публичный ключ есть в `~/.ssh/authorized_keys` на сервере
   - Проверьте права доступа на сервере:
     ```bash
     chmod 700 ~/.ssh
     chmod 600 ~/.ssh/authorized_keys
     ```

2. **Неправильный приватный ключ в GitHub Secrets**
   - Убедитесь, что в `SSH_PRIVATE_KEY` добавлен именно приватный ключ (не публичный!)
   - Публичный ключ имеет расширение `.pub` и начинается с `ssh-ed25519` или `ssh-rsa`
   - Приватный ключ начинается с `-----BEGIN OPENSSH PRIVATE KEY-----`

3. **Несоответствие пользователя**
   - Убедитесь, что `SERVER_USER` в секретах совпадает с пользователем, которому принадлежит `~/.ssh/authorized_keys`

4. **Сервер не разрешает аутентификацию по ключам**
   - Проверьте на сервере `/etc/ssh/sshd_config`:
     ```
     PubkeyAuthentication yes
     AuthorizedKeysFile .ssh/authorized_keys
     ```
   - После изменений перезапустите SSH: `sudo systemctl restart sshd`

### Проверка на сервере:

Подключитесь к серверу и проверьте:
```bash
# Проверьте наличие публичного ключа
cat ~/.ssh/authorized_keys

# Проверьте права доступа
ls -la ~/.ssh/
# Должно быть:
# drwx------ .ssh
# -rw------- authorized_keys
```

## Важно:

- Убедитесь, что на сервере установлен Docker
- Убедитесь, что пользователь `SERVER_USER` имеет права на выполнение Docker команд
- Файл `config/gs_creds.json` должен быть скопирован на сервер вручную перед первым запуском
- **SSH ключи работают БЕЗ пароля** - если требуется пароль, значит ключ не настроен правильно

